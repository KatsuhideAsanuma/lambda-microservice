# Lambda Microservice 包括的調査計画書

## 作成日時: 2025年7月15日
## 最終更新: 2025年7月15日 12:55 JST
## 対象バージョン: v1.0.x
## 調査目的: 現在の問題特定、機能実現方法の理解、テストカバレッジの評価

---

## 調査概要

### 調査項目
1. **発生している問題の特定と分析** ✅ **完了**
2. **READMEの機能をソースコードがどう実現しているかの構造・フロー調査** 🔄 **次期予定**
3. **テストのカバレッジ分析** 🔄 **次期予定**

### 調査方針
- **段階的調査**: 各項目を独立して調査し、相互関係を分析
- **実証的アプローチ**: 実際のコード実行とテストを通じた検証
- **文書化**: 調査結果を詳細に記録し、今後の改善に活用

---

## 1. 発生している問題の調査計画 ✅ **完了**

### 1.1 確認された問題（Phase 1完了）

#### 1.1.1 根本的な問題 - Rustバージョン互換性
- **現象**: Rust 1.51.0（2021年3月）が現代的な依存関係と互換性がない
- **影響**: 全Rustコンテナ（controller、rust-runtime）のビルドが失敗
- **原因**: edition 2021がサポートされていない、ahash等の基本クレートでバージョン競合

#### 1.1.2 依存関係の複雑性問題
- **WebAssembly関連**: wasmtime、wasm-packの互換性問題
- **gRPC関連**: tonic、prostのバージョン競合
- **Kubernetes関連**: kube、k8s-openapiのバージョン競合
- **SQLx**: tokio-postgresとの競合

### 1.2 実施した緊急対応（Phase 1.5完了）

#### ✅ 完了した一時的解決策（2025年7月15日 12:19-12:48 JST）

**1. 機能の一時的無効化**:
- WebAssembly機能: wasmtime関連を無効化 → シミュレーション実行に変更
- gRPC機能: tonic関連を無効化 → エラー返却に変更
- Kubernetes機能: kube関連を無効化 → 静的マッピングに変更
- SQLx: tokio-postgres直接使用に変更
- ログ機能: tracing-actix-webを無効化

**2. バージョン調整**:
- Rustエディション: 2021 → 2018
- actix-web: 4.3.1 → 3.3
- actix-cors: 0.6.4 → 0.5
- tokio-postgres: 0.7.8 → 0.7.0
- deadpool-postgres: 0.10.5 → 0.10.0

**3. 修正されたファイル**:
- `controller/Cargo.toml`, `runtimes/rust/Cargo.toml`: 依存関係の調整
- `controller/src/runtime.rs`: WebAssembly機能の無効化
- `controller/src/protocol/grpc.rs`: gRPC機能の無効化
- `controller/src/kubernetes.rs`: Kubernetes API呼び出しの無効化
- `controller/src/config.rs`: WebAssembly設定の削除
- `controller/build.rs`: gRPCプロトコル生成の無効化
- `controller/src/main.rs`: tracing-actix-web使用の削除
- `runtimes/rust/src/main.rs`: WebAssembly実行のシミュレーション実装

### 1.3 現在の状況

#### 🟢 動作する機能
- HTTP API エンドポイント
- データベース接続（PostgreSQL）
- Redis キャッシュ
- セッション管理
- 基本的なランタイム選択
- OpenFaaS連携（設定されている場合）

#### 🟡 一時的に無効化された機能
- **WebAssembly実行**: シミュレーション実行で代替
- **gRPC通信**: エラー返却で代替
- **Kubernetes動的発見**: 静的マッピングで代替
- **高度なログ**: HTTP リクエストトレースが簡素化

---

## 2. ソースの構造とフロー調査計画 🔄 **Phase 2予定**

### 2.1 READMEの機能要件分析

#### 2.1.1 READMEから抽出する機能要件
1. **多言語コード実行基盤**
   - Node.js、Python、Rustの実行環境 ✅ **基本機能動作中**
   - 言語切り替えメカニズム ✅ **動作中**
   - Language-Titleヘッダーによる動的ルーティング ✅ **動作中**

2. **APIエンドポイント仕様**
   - 初期化API (`POST /api/v1/initialize`) 🔄 **要確認**
   - 実行API (`POST /api/v1/execute/{request_id}`) 🔄 **要確認**
   - セッション状態取得API (`GET /api/v1/sessions/{request_id}`) 🔄 **要確認**
   - 関数一覧API (`GET /api/v1/functions`) 🔄 **要確認**
   - 関数詳細API (`GET /api/v1/functions/{language_title}`) 🔄 **要確認**

3. **認証・認可** 🔄 **要調査**
   - JWTベース認証
   - Authorization: Bearer {token}
   - 権限管理

4. **データ永続化** ✅ **基本機能動作中**
   - PostgreSQL（ログ、関数メタデータ）
   - Redis（キャッシュ、セッション）

5. **監視・ログ** 🟡 **一部制限あり**
   - Prometheus、Grafana 🔄 **要確認**
   - Elastic Stack 🔄 **要確認**

### 2.2 ソースコード構造分析（Phase 2計画）

#### Phase 2.1: アーキテクチャ概要の調査
**目的**: 全体的な設計思想と構造を理解
**前提条件**: 基本機能が動作している状態

**実行手順**:
1. **プロジェクト構造の分析**
   ```bash
   # 現在の動作状況を確認
   docker-compose ps
   curl http://localhost:8080/health
   
   # ディレクトリ構造の詳細調査
   find . -type f -name "*.rs" | head -20
   find . -type f -name "*.toml" | head -10
   find . -type f -name "*.sql" | head -10
   ```

2. **主要コンポーネントの動作確認**
   - Rustコントローラー (`controller/`) ✅ **動作中**
   - ランタイムエンジン (`runtimes/`) ✅ **動作中（一部シミュレーション）**
   - データベーススキーマ (`database/`) ✅ **動作中**
   - Kubernetes設定 (`kubernetes/`) 🟡 **静的設定**
   - OpenFaaS設定 (`openfaas/`) 🔄 **要確認**

3. **依存関係の分析**
   ```bash
   # 現在の依存関係状況
   cargo tree --manifest-path controller/Cargo.toml
   # 無効化された依存関係の確認
   grep -r "TEMPORARILY DISABLED" controller/
   ```

**成果物**:
- アーキテクチャ概要図（現在の制約を含む）
- コンポーネント依存関係図（一時無効化機能を明記）

#### Phase 2.2: 各コンポーネントの詳細分析
**目的**: 各コンポーネントの実装詳細を調査（現在の制約下で）

**実行手順**:
1. **コントローラーの分析** (`controller/src/`)
   - `main.rs`: アプリケーションエントリーポイント ✅ **修正済み**
   - `api.rs`: HTTPエンドポイント実装 🔄 **要確認**
   - `config.rs`: 設定管理 ✅ **修正済み**
   - `database.rs`: データベース接続・操作 ✅ **動作中**
   - `session.rs`: セッション管理 🔄 **要確認**
   - `function.rs`: 関数メタデータ管理 🔄 **要確認**
   - `runtime.rs`: ランタイム管理 ✅ **修正済み（一部シミュレーション）**
   - `cache.rs`: Redis キャッシュ操作 🔄 **要確認**
   - `logger.rs`: ログ記録 🔄 **要確認**

2. **ランタイムエンジンの分析** (`runtimes/`)
   - `nodejs/`: Node.js実行環境 ✅ **動作中**
   - `python/`: Python実行環境 ✅ **動作中**
   - `rust/`: Rust実行環境 ✅ **シミュレーション動作中**

3. **データベーススキーマの分析** (`database/migrations/`)
   - マイグレーション履歴 ✅ **確認済み**
   - テーブル設計 🔄 **要詳細確認**
   - インデックス設計 🔄 **要詳細確認**

**成果物**:
- コンポーネント詳細設計書（現在の制約を含む）
- データベース設計書
- 一時無効化機能の復旧計画

#### Phase 2.3: 機能実現フローの分析
**目的**: READMEの機能がどのように実現されているかを追跡（現在の状態で）

**実行手順**:
1. **初期化フローの分析**
   ```
   HTTP Request → api.rs → session.rs → database.rs → PostgreSQL
                         → runtime.rs → Runtime Container (シミュレーション含む)
   ```

2. **実行フローの分析**
   ```
   HTTP Request → api.rs → session.rs → runtime.rs → Runtime Container
                         → database.rs → PostgreSQL (ログ記録)
                         → cache.rs → Redis (キャッシュ)
   ```

3. **認証フローの分析** 🔄 **要確認**
   ```
   HTTP Request → JWT検証 → 権限チェック → API実行
   ```

4. **エラーハンドリングフローの分析**
   ```
   Error → logger.rs → database.rs → PostgreSQL (エラーログ)
   ```

**成果物**:
- 機能実現フロー図（現在の制約を明記）
- シーケンス図（一時無効化機能を含む）

### 2.3 READMEとの整合性分析（Phase 2.4）

#### 実行手順:
1. **機能要件の対応表作成**
   - README記載機能 vs 実装状況（現在の制約を含む）
   - 一時無効化機能の特定
   - 実装方法の差異分析

2. **API仕様の整合性確認**
   - README記載のAPI vs 実装API
   - レスポンス形式の確認（シミュレーション応答を含む）
   - エラーハンドリングの確認

**成果物**:
- 機能要件対応表（現在の状況を反映）
- API仕様比較表
- 機能復旧優先度表

---

## 3. テストカバレッジ調査計画 🔄 **Phase 3予定**

### 3.1 現在のテスト状況分析

#### Phase 3.1: テストファイルの調査
**目的**: 既存のテストコードを把握（現在の制約下で）
**前提条件**: 基本機能が動作し、構造が理解されている状態

**実行手順**:
1. **テストファイルの発見**
   ```bash
   find . -name "*test*.rs" -o -name "*_test.rs" -o -name "test_*.rs"
   find . -name "tests" -type d
   ```

2. **テストの種類分類**
   - 単体テスト (Unit Tests) 🔄 **現在の制約下で実行可能性確認**
   - 統合テスト (Integration Tests) 🔄 **現在の制約下で実行可能性確認**
   - エンドツーエンドテスト (E2E Tests) 🔄 **現在の制約下で実行可能性確認**

3. **テストフレームワークの特定**
   - 使用されているテストライブラリ
   - モックライブラリ（一時無効化機能のモック含む）
   - テストヘルパー

**成果物**:
- テストファイル一覧（実行可能性を含む）
- テスト分類表（現在の制約を反映）

#### Phase 3.2: テストカバレッジ測定
**目的**: 実際のコードカバレッジを測定（現在の状態で）

**実行手順**:
1. **カバレッジツールの設定**
   ```bash
   # 現在のRustバージョンと互換性のあるツール選択
   cargo install cargo-tarpaulin
   ```

2. **カバレッジ測定の実行**
   ```bash
   # 現在動作する機能のカバレッジ測定
   cargo tarpaulin --manifest-path controller/Cargo.toml --out html --output-dir coverage
   
   # 一時無効化機能を除外したカバレッジ
   cargo tarpaulin --exclude-files "*/disabled/*" --out html --output-dir coverage
   ```

3. **カバレッジレポートの分析**
   - ライン カバレッジ（動作機能のみ）
   - ブランチ カバレッジ（動作機能のみ）
   - 関数 カバレッジ（動作機能のみ）

**成果物**:
- カバレッジレポート (HTML)（現在の状況を反映）
- カバレッジ分析レポート（一時無効化機能を考慮）

#### Phase 3.3: テストの品質分析
**目的**: テストの品質と有効性を評価（現在の制約下で）

**実行手順**:
1. **テストケースの網羅性確認**
   - 正常系テスト（動作機能）
   - 異常系テスト（動作機能）
   - 境界値テスト（動作機能）
   - エラーハンドリングテスト（シミュレーション機能含む）

2. **モック・スタブの使用状況**
   - 外部依存関係のモック
   - データベースのモック
   - HTTPクライアントのモック
   - 一時無効化機能のモック

3. **テストの保守性確認**
   - テストコードの可読性
   - テストデータの管理
   - テストの独立性（一時無効化機能を考慮）

**成果物**:
- テスト品質評価レポート（現在の制約を反映）
- テスト改善提案（機能復旧を考慮）

### 3.2 テストカバレッジ向上計画（Phase 3.4）

#### Phase 3.4.1: 未カバー領域の特定
**実行手順**:
1. **低カバレッジ領域の特定**
   - カバレッジが低い関数・モジュール（動作機能）
   - 全くテストされていない機能（動作機能）
   - 複雑な条件分岐（シミュレーション機能含む）

2. **クリティカルパスの特定**
   - 重要な業務ロジック（現在動作中）
   - エラーハンドリング（シミュレーション含む）
   - セキュリティ関連機能

**成果物**:
- 未カバー領域レポート（現在の状況を反映）
- 優先度付きテスト追加計画（機能復旧計画と連動）

#### Phase 3.4.2: テスト追加の実装計画
**実行手順**:
1. **単体テストの追加**
   - 各モジュールの関数単位テスト（動作機能）
   - エッジケースのテスト（シミュレーション機能含む）
   - エラーハンドリングのテスト

2. **統合テストの追加**
   - API エンドポイントのテスト（現在の応答形式）
   - データベース統合テスト
   - Redis統合テスト

3. **エンドツーエンドテストの追加**
   - 実際のユースケースのテスト（現在の制約下）
   - 複数コンポーネント間のテスト

**成果物**:
- テスト追加実装計画（段階的復旧を考慮）
- テスト自動化方針（現在の制約を反映）

---

## 4. 実行スケジュール（更新版）

### ✅ Phase 1: 問題調査（完了 - 2025/07/15）
- **Day 1**: エラーログ分析、デバッグ環境設定 ✅
- **成果**: 設定問題解決、ビルドエラー根本原因特定
- **発見**: Rust Edition 2024互換性問題、複雑な依存関係問題

### ✅ Phase 1.5: 緊急ビルド修正（完了 - 2025/07/15）
- **期間**: 2025年7月15日 12:19-12:48 JST（29分間）
- **成果**: 基本機能の動作確認、一時的解決策の実装
- **状況**: 🟡 一時的解決済み - 基本機能動作中

#### 実施した作業
- ✅ Rustエディション調整（2021 → 2018）
- ✅ 依存関係バージョン調整
- ✅ WebAssembly機能の一時無効化
- ✅ gRPC機能の一時無効化
- ✅ Kubernetes機能の一時無効化
- ✅ 基本機能の動作確認

### 🔄 Phase 2: 構造・フロー調査（次期予定 - 基本機能動作確認後）
**前提条件**: Phase 1.5完了、基本機能動作確認済み ✅

#### Phase 2.1: アーキテクチャ概要調査（1-2日）
- **Day 1**: プロジェクト構造分析、動作確認
- **Day 2**: コンポーネント依存関係分析

#### Phase 2.2: コンポーネント詳細分析（3-5日）
- **Day 3-4**: コントローラー詳細分析（現在の制約を含む）
- **Day 5**: ランタイムエンジン分析（シミュレーション機能含む）

#### Phase 2.3: 機能実現フロー分析（2日）
- **Day 6-7**: APIフロー分析、READMEとの整合性確認

### 🔄 Phase 3: テストカバレッジ調査（Phase 2完了後）
**前提条件**: Phase 2完了、システム理解完了

#### Phase 3.1-3.3: テスト状況分析（3-4日）
- **Day 1-2**: テストファイル調査、実行可能性確認
- **Day 3-4**: カバレッジ測定、品質分析

#### Phase 3.4: テスト改善計画（3日）
- **Day 5-7**: 未カバー領域特定、改善計画策定

### 🔄 Phase 4: 統合・レポート作成（1週間）
- **Day 1-3**: 調査結果の統合分析
- **Day 4-5**: 改善提案の策定（機能復旧計画含む）
- **Day 6-7**: 最終レポート作成

### 🔄 Phase 5: 機能復旧計画（Phase 4完了後）
**新規追加フェーズ**: 一時無効化機能の段階的復旧

#### Phase 5.1: Rustツールチェーン更新（1-2週間）
- Rust 1.51.0 → 1.70.0以上への更新
- CI/CD環境の調整
- 依存関係の再評価

#### Phase 5.2: 機能段階的復旧（2-3週間）
1. **WebAssembly機能**: wasmtime、wasm-packの復旧
2. **gRPC機能**: tonic、prostの復旧
3. **Kubernetes機能**: kube、k8s-openapiの復旧
4. **高度なログ機能**: tracing-actix-webの復旧

#### Phase 5.3: テスト復旧・追加（1週間）
- 復旧機能のテスト追加
- 統合テストの実行
- E2Eテストの確認

---

## 5. 成果物一覧（更新版）

### 5.1 問題調査成果物 ✅ **完了**
- **✅ エラーログ分析レポート**
  - 発生エラーの詳細分析
  - 根本原因の特定（Rustバージョン互換性問題）
  - 修正優先度の評価

- **✅ 依存関係問題分析レポート**
  - WebAssembly、gRPC、Kubernetes依存関係の問題点
  - 一時的解決策の実装
  - 段階的復旧計画

- **✅ 緊急対応実施レポート**
  - 実施した一時的解決策の詳細
  - 修正されたファイル一覧
  - 現在の動作状況

### 5.2 構造・フロー調査成果物 🔄 **Phase 2予定**
- **アーキテクチャ概要図**（現在の制約を含む）
  - システム全体の構造
  - コンポーネント間の関係
  - データフロー（一時無効化機能を明記）

- **コンポーネント詳細設計書**
  - 各モジュールの詳細仕様（現在の状態）
  - 関数・メソッドの説明
  - 依存関係の詳細（一時無効化を含む）

- **機能実現フロー図**
  - APIエンドポイントの処理フロー（現在の制約下）
  - データベース操作フロー
  - エラーハンドリングフロー（シミュレーション含む）

- **READMEとの整合性分析**
  - 機能要件対応表（現在の状況を反映）
  - API仕様比較表
  - 一時無効化機能の特定と復旧計画

### 5.3 テストカバレッジ調査成果物 🔄 **Phase 3予定**
- **カバレッジレポート**（現在の制約を反映）
  - HTML形式のカバレッジレポート
  - モジュール別カバレッジ分析（動作機能のみ）
  - 時系列カバレッジ推移

- **テスト品質評価レポート**
  - テストケースの網羅性評価（現在の制約下）
  - テストの保守性評価
  - テスト改善提案（機能復旧を考慮）

- **テスト追加実装計画**
  - 優先度付きテスト追加リスト（段階的復旧対応）
  - テスト自動化方針
  - CIパイプライン改善提案

### 5.4 統合成果物 🔄 **Phase 4予定**
- **包括的問題分析レポート**
  - 全調査結果の統合
  - 問題の相互関係分析
  - 総合的な改善提案（機能復旧含む）

- **実装改善ロードマップ**
  - 短期改善項目（1-2週間）: 現在の制約下での改善
  - 中期改善項目（1-2ヶ月）: 機能復旧と改善
  - 長期改善項目（3-6ヶ月）: 全機能復旧と最適化

### 5.5 機能復旧成果物 🔄 **Phase 5予定**
- **機能復旧計画書**
  - 段階的復旧スケジュール
  - 各機能の復旧手順
  - リスク評価と対策

- **Rustツールチェーン更新ガイド**
  - 更新手順書
  - 互換性確認方法
  - ロールバック手順

---

## 6. 調査ツール・環境（更新版）

### 6.1 使用ツール（現在の制約対応）
- **コード分析**: `cargo clippy`, `cargo audit`, `cargo tree`（Rust 1.51.0対応）
- **カバレッジ測定**: `cargo tarpaulin`（互換バージョン）
- **ログ分析**: `docker-compose logs`, `grep`, `awk`
- **データベース調査**: `psql`, `redis-cli`
- **性能分析**: `cargo bench`（基本機能のみ）

### 6.2 環境設定（現在の制約対応）
- **デバッグ環境**: `RUST_LOG=debug`, `RUST_BACKTRACE=1`
- **テスト環境**: 独立したテストデータベース
- **カバレッジ環境**: Rust 1.51.0対応設定

### 6.3 制約事項
- **Rustバージョン**: 1.51.0固定（一時的）
- **無効化機能**: WebAssembly、gRPC、Kubernetes機能は調査対象外（Phase 5で復旧後に調査）
- **テスト実行**: 現在動作する機能のみ

---

## 7. 成功基準（更新版）

### 7.1 問題調査の成功基準 ✅ **達成**
- [x] 全ての発生エラーの根本原因を特定
- [x] 修正可能性と修正工数を評価
- [x] 緊急度・重要度の優先順位を設定
- [x] 一時的解決策の実装と動作確認

### 7.2 構造・フロー調査の成功基準 🔄 **Phase 2目標**
- [ ] README記載の全機能について実装状況を確認（現在の制約を含む）
- [ ] 一時無効化機能を特定し、復旧計画を策定
- [ ] システム全体の理解を文書化（現在の状態で）

### 7.3 テストカバレッジ調査の成功基準 🔄 **Phase 3目標**
- [ ] 動作中の全モジュールのカバレッジを測定
- [ ] カバレッジ70%以上を達成する計画を策定（現在の制約下で）
- [ ] 継続的なカバレッジ改善の仕組みを構築

### 7.4 機能復旧の成功基準 🔄 **Phase 5目標**
- [ ] Rustツールチェーンの更新完了
- [ ] WebAssembly機能の復旧
- [ ] gRPC機能の復旧
- [ ] Kubernetes機能の復旧
- [ ] 全機能のテスト実行確認

---

## 8. 承認・レビュー（更新版）

- [x] 調査計画の技術レビュー
- [x]
