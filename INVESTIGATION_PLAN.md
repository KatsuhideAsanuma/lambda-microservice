# Lambda Microservice 包括的調査計画書

## 作成日時: 2025年7月15日
## 対象バージョン: v1.0.x
## 調査目的: 現在の問題特定、機能実現方法の理解、テストカバレッジの評価

---

## 調査概要

### 調査項目
1. **発生している問題の特定と分析**
2. **READMEの機能をソースコードがどう実現しているかの構造・フロー調査**
3. **テストのカバレッジ分析**

### 調査方針
- **段階的調査**: 各項目を独立して調査し、相互関係を分析
- **実証的アプローチ**: 実際のコード実行とテストを通じた検証
- **文書化**: 調査結果を詳細に記録し、今後の改善に活用

---

## 1. 発生している問題の調査計画

### 1.1 現在確認されている問題

#### 1.1.1 APIエンドポイントの問題
- **現象**: `/api/v1/functions` エンドポイントが 500 エラー
- **エラーメッセージ**: "Requested application data is not configured correctly"
- **影響範囲**: 関数一覧取得、関数詳細取得、初期化・実行API

#### 1.1.2 依存性注入の問題
- **現象**: Actix-webのData依存性注入でtrait objectの型不整合
- **影響範囲**: 全APIエンドポイント

### 1.2 問題調査の実行計画

#### Phase 1: エラーログの詳細分析
**目的**: エラーの根本原因を特定

**実行手順**:
1. **デバッグログの有効化**
   ```bash
   # RUST_LOG=debug環境変数の設定
   # トレースレベルログの収集
   ```

2. **エラー発生箇所の特定**
   - Actix-webミドルウェアのエラートレース
   - 依存性注入の失敗箇所の特定
   - HTTPリクエスト処理フローの分析

3. **データベース接続の検証**
   - PostgreSQL接続状態の確認
   - Redis接続状態の確認
   - 接続プールの状態確認

**成果物**:
- エラーログ分析レポート
- 問題発生箇所のマッピング

#### Phase 2: 型システムの問題分析
**目的**: Trait objectとData依存性注入の問題を解決

**実行手順**:
1. **型システムの整合性チェック**
   ```rust
   // 各Traitの実装状況確認
   // Arc<dyn Trait>の使用箇所分析
   // Data<T>の型整合性確認
   ```

2. **コンパイルエラーの詳細分析**
   ```bash
   cargo check --verbose
   cargo clippy --all-targets --all-features
   ```

3. **ランタイムエラーの追跡**
   - パニック発生箇所の特定
   - unwrap()の使用箇所確認
   - エラーハンドリングの妥当性確認

**成果物**:
- 型システム問題分析レポート
- 修正案の提案

#### Phase 3: 設定・環境の問題分析
**目的**: 設定ファイルや環境変数の問題を特定

**実行手順**:
1. **設定ファイルの検証**
   - secrets/内のファイル形式確認
   - 改行文字問題の検証
   - 設定値の妥当性確認

2. **環境変数の確認**
   - Docker環境内の環境変数
   - 設定読み込み処理の検証

3. **サービス間通信の確認**
   - PostgreSQLとの通信確認
   - Redisとの通信確認
   - ランタイムサービスとの通信確認

**成果物**:
- 設定・環境問題分析レポート
- 推奨設定の提案

---

## 2. ソースの構造とフロー調査計画

### 2.1 READMEの機能要件分析

#### 2.1.1 READMEから抽出する機能要件
1. **多言語コード実行基盤**
   - Node.js、Python、Rustの実行環境
   - 言語切り替えメカニズム
   - Language-Titleヘッダーによる動的ルーティング

2. **APIエンドポイント仕様**
   - 初期化API (`POST /api/v1/initialize`)
   - 実行API (`POST /api/v1/execute/{request_id}`)
   - セッション状態取得API (`GET /api/v1/sessions/{request_id}`)
   - 関数一覧API (`GET /api/v1/functions`)
   - 関数詳細API (`GET /api/v1/functions/{language_title}`)

3. **認証・認可**
   - JWTベース認証
   - Authorization: Bearer {token}
   - 権限管理

4. **データ永続化**
   - PostgreSQL（ログ、関数メタデータ）
   - Redis（キャッシュ、セッション）

5. **監視・ログ**
   - Prometheus、Grafana
   - Elastic Stack

### 2.2 ソースコード構造分析

#### Phase 1: アーキテクチャ概要の調査
**目的**: 全体的な設計思想と構造を理解

**実行手順**:
1. **プロジェクト構造の分析**
   ```bash
   # ディレクトリ構造の詳細調査
   find . -type f -name "*.rs" | head -20
   find . -type f -name "*.toml" | head -10
   find . -type f -name "*.sql" | head -10
   ```

2. **主要コンポーネントの特定**
   - Rustコントローラー (`controller/`)
   - ランタイムエンジン (`runtimes/`)
   - データベーススキーマ (`database/`)
   - Kubernetes設定 (`kubernetes/`)
   - OpenFaaS設定 (`openfaas/`)

3. **依存関係の分析**
   ```bash
   # Cargo.tomlの分析
   # 外部クレートの使用状況
   # 内部モジュールの依存関係
   ```

**成果物**:
- アーキテクチャ概要図
- コンポーネント依存関係図

#### Phase 2: 各コンポーネントの詳細分析
**目的**: 各コンポーネントの実装詳細を調査

**実行手順**:
1. **コントローラーの分析** (`controller/src/`)
   - `main.rs`: アプリケーションエントリーポイント
   - `api.rs`: HTTPエンドポイント実装
   - `config.rs`: 設定管理
   - `database.rs`: データベース接続・操作
   - `session.rs`: セッション管理
   - `function.rs`: 関数メタデータ管理
   - `runtime.rs`: ランタイム管理
   - `cache.rs`: Redis キャッシュ操作
   - `logger.rs`: ログ記録

2. **ランタイムエンジンの分析** (`runtimes/`)
   - `nodejs/`: Node.js実行環境
   - `python/`: Python実行環境
   - `rust/`: Rust実行環境（WebAssembly）

3. **データベーススキーマの分析** (`database/migrations/`)
   - マイグレーション履歴
   - テーブル設計
   - インデックス設計

**成果物**:
- コンポーネント詳細設計書
- データベース設計書

#### Phase 3: 機能実現フローの分析
**目的**: READMEの機能がどのように実現されているかを追跡

**実行手順**:
1. **初期化フローの分析**
   ```
   HTTP Request → api.rs → session.rs → database.rs → PostgreSQL
                         → runtime.rs → Runtime Container
   ```

2. **実行フローの分析**
   ```
   HTTP Request → api.rs → session.rs → runtime.rs → Runtime Container
                         → database.rs → PostgreSQL (ログ記録)
                         → cache.rs → Redis (キャッシュ)
   ```

3. **認証フローの分析**
   ```
   HTTP Request → JWT検証 → 権限チェック → API実行
   ```

4. **エラーハンドリングフローの分析**
   ```
   Error → logger.rs → database.rs → PostgreSQL (エラーログ)
   ```

**成果物**:
- 機能実現フロー図
- シーケンス図

### 2.3 READMEとの整合性分析

#### 実行手順:
1. **機能要件の対応表作成**
   - README記載機能 vs 実装状況
   - 未実装機能の特定
   - 実装方法の差異分析

2. **API仕様の整合性確認**
   - README記載のAPI vs 実装API
   - レスポンス形式の確認
   - エラーハンドリングの確認

**成果物**:
- 機能要件対応表
- API仕様比較表

---

## 3. テストカバレッジ調査計画

### 3.1 現在のテスト状況分析

#### Phase 1: テストファイルの調査
**目的**: 既存のテストコードを把握

**実行手順**:
1. **テストファイルの発見**
   ```bash
   find . -name "*test*.rs" -o -name "*_test.rs" -o -name "test_*.rs"
   find . -name "tests" -type d
   ```

2. **テストの種類分類**
   - 単体テスト (Unit Tests)
   - 統合テスト (Integration Tests)
   - エンドツーエンドテスト (E2E Tests)

3. **テストフレームワークの特定**
   - 使用されているテストライブラリ
   - モックライブラリ
   - テストヘルパー

**成果物**:
- テストファイル一覧
- テスト分類表

#### Phase 2: テストカバレッジ測定
**目的**: 実際のコードカバレッジを測定

**実行手順**:
1. **カバレッジツールの設定**
   ```bash
   # tarpaulin または grcov の設定
   cargo install cargo-tarpaulin
   ```

2. **カバレッジ測定の実行**
   ```bash
   # 全テストのカバレッジ測定
   cargo tarpaulin --out html --output-dir coverage
   
   # モジュール別カバレッジ
   cargo tarpaulin --out html --output-dir coverage --exclude-files "*/tests/*"
   ```

3. **カバレッジレポートの分析**
   - ライン カバレッジ
   - ブランチ カバレッジ
   - 関数 カバレッジ

**成果物**:
- カバレッジレポート (HTML)
- カバレッジ分析レポート

#### Phase 3: テストの品質分析
**目的**: テストの品質と有効性を評価

**実行手順**:
1. **テストケースの網羅性確認**
   - 正常系テスト
   - 異常系テスト
   - 境界値テスト
   - エラーハンドリングテスト

2. **モック・スタブの使用状況**
   - 外部依存関係のモック化
   - データベースのモック
   - HTTPクライアントのモック

3. **テストの保守性確認**
   - テストコードの可読性
   - テストデータの管理
   - テストの独立性

**成果物**:
- テスト品質評価レポート
- テスト改善提案

### 3.2 テストカバレッジ向上計画

#### Phase 1: 未カバー領域の特定
**実行手順**:
1. **低カバレッジ領域の特定**
   - カバレッジが低い関数・モジュール
   - 全くテストされていない機能
   - 複雑な条件分岐

2. **クリティカルパスの特定**
   - 重要な業務ロジック
   - エラーハンドリング
   - セキュリティ関連機能

**成果物**:
- 未カバー領域レポート
- 優先度付きテスト追加計画

#### Phase 2: テスト追加の実装計画
**実行手順**:
1. **単体テストの追加**
   - 各モジュールの関数単位テスト
   - エッジケースのテスト
   - エラーハンドリングのテスト

2. **統合テストの追加**
   - API エンドポイントのテスト
   - データベース統合テスト
   - Redis統合テスト

3. **エンドツーエンドテストの追加**
   - 実際のユースケースのテスト
   - 複数コンポーネント間のテスト

**成果物**:
- テスト追加実装計画
- テスト自動化方針

---

## 4. 実行スケジュール

### Week 1: 問題調査
- **Day 1-2**: エラーログ分析、デバッグ環境設定
- **Day 3-4**: 型システム問題分析
- **Day 5-7**: 設定・環境問題分析

### Week 2: 構造・フロー調査
- **Day 1-2**: アーキテクチャ概要調査
- **Day 3-5**: コンポーネント詳細分析
- **Day 6-7**: 機能実現フロー分析

### Week 3: テストカバレッジ調査
- **Day 1-2**: テストファイル調査
- **Day 3-4**: カバレッジ測定
- **Day 5-7**: テスト品質分析、改善計画策定

### Week 4: 統合・レポート作成
- **Day 1-3**: 調査結果の統合分析
- **Day 4-5**: 改善提案の策定
- **Day 6-7**: 最終レポート作成

---

## 5. 成果物一覧

### 5.1 問題調査成果物
- **エラーログ分析レポート**
  - 発生エラーの詳細分析
  - 根本原因の特定
  - 修正優先度の評価

- **型システム問題分析レポート**
  - Trait object問題の詳細
  - 依存性注入の問題点
  - 修正案の提案

- **設定・環境問題分析レポート**
  - 設定ファイルの問題点
  - 環境変数の課題
  - 推奨設定の提案

### 5.2 構造・フロー調査成果物
- **アーキテクチャ概要図**
  - システム全体の構造
  - コンポーネント間の関係
  - データフロー

- **コンポーネント詳細設計書**
  - 各モジュールの詳細仕様
  - 関数・メソッドの説明
  - 依存関係の詳細

- **機能実現フロー図**
  - APIエンドポイントの処理フロー
  - データベース操作フロー
  - エラーハンドリングフロー

- **READMEとの整合性分析**
  - 機能要件対応表
  - API仕様比較表
  - 未実装機能の特定

### 5.3 テストカバレッジ調査成果物
- **カバレッジレポート**
  - HTML形式のカバレッジレポート
  - モジュール別カバレッジ分析
  - 時系列カバレッジ推移

- **テスト品質評価レポート**
  - テストケースの網羅性評価
  - テストの保守性評価
  - テスト改善提案

- **テスト追加実装計画**
  - 優先度付きテスト追加リスト
  - テスト自動化方針
  - CIパイプライン改善提案

### 5.4 統合成果物
- **包括的問題分析レポート**
  - 全調査結果の統合
  - 問題の相互関係分析
  - 総合的な改善提案

- **実装改善ロードマップ**
  - 短期改善項目（1-2週間）
  - 中期改善項目（1-2ヶ月）
  - 長期改善項目（3-6ヶ月）

---

## 6. 調査ツール・環境

### 6.1 使用ツール
- **コード分析**: `cargo clippy`, `cargo audit`, `cargo tree`
- **カバレッジ測定**: `cargo tarpaulin`, `grcov`
- **ログ分析**: `docker-compose logs`, `grep`, `awk`
- **データベース調査**: `psql`, `redis-cli`
- **性能分析**: `cargo bench`, `flamegraph`

### 6.2 環境設定
- **デバッグ環境**: `RUST_LOG=debug`, `RUST_BACKTRACE=1`
- **テスト環境**: 独立したテストデータベース
- **カバレッジ環境**: 最適化無効化設定

---

## 7. 成功基準

### 7.1 問題調査の成功基準
- [ ] 全ての発生エラーの根本原因を特定
- [ ] 修正可能性と修正工数を評価
- [ ] 緊急度・重要度の優先順位を設定

### 7.2 構造・フロー調査の成功基準
- [ ] README記載の全機能について実装状況を確認
- [ ] 未実装機能を特定し、実装計画を策定
- [ ] システム全体の理解を文書化

### 7.3 テストカバレッジ調査の成功基準
- [ ] 全モジュールのカバレッジを測定
- [ ] カバレッジ70%以上を達成する計画を策定
- [ ] 継続的なカバレッジ改善の仕組みを構築

---

## 8. 承認・レビュー

- [ ] 調査計画の技術レビュー
- [ ] 調査スケジュールの承認
- [ ] 成果物の品質基準の確認
- [ ] 調査結果の活用方針の決定

**調査責任者**: _______________  
**レビュー完了日**: _______________  
**調査開始予定日**: _______________
